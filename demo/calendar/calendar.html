<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="css/calendar.css">
</head>
<body>
    <div class="result">yyyy-MM-dd</div>
    <div class="calendar">
        <div class="header">
            <span class="prevYear prev changeYear"><i></i><i></i></span>
            <span class="prevMonth prev changeMonth"><i></i></span>
            <div>
                <span class="year"></span>
                <span class="month"></span>
            </div>
            <span class="nextMonth next changeMonth"><i></i></span>
            <span class="nextYear next changeYear"><i></i><i></i></span>
        </div>
        <div class="main">
            <div class="content">
                <div class="week">
                    <span>日</span>
                    <span>一</span>
                    <span>二</span>
                    <span>三</span>
                    <span>四</span>
                    <span>五</span>
                    <span>六</span>
                </div>
                <div>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                </div>
                <div>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                </div>
                <div>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                </div>
                <div>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                </div>
                <div>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                </div>
                <div>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                    <span class="time"></span>
                </div>
            </div>
            
        </div>
        <div class="footer">
            <span class="clear">清除</span>
            <span class="nowTime">现在</span>
            <span class="confirm">确定</span>
        </div>
    </div>
    <script>
        const oTime = document.getElementsByClassName("time"),
            oMain = document.getElementsByClassName("main")[0],
            oYear = document.getElementsByClassName("year")[0],
            oMonth = document.getElementsByClassName("month")[0],
            oClear = document.getElementsByClassName("clear")[0],
            oNowTime = document.getElementsByClassName("nowTime")[0],
            oConfirm = document.getElementsByClassName("confirm")[0],
            oPrevYear = document.getElementsByClassName("prevYear")[0],
            oNextMonth = document.getElementsByClassName("nextMonth")[0],
            oNextYear = document.getElementsByClassName("nextYear")[0],
            oPrevMonth = document.getElementsByClassName("prevMonth")[0],
            oChangeYear = document.getElementsByClassName("changeYear"),
            oChangeMonth = document.getElementsByClassName("changeMonth"),
            oResult = document.getElementsByClassName("result")[0];

        const nowTime = new Date();
        let [nowYearCount , nowMonthCount , nowDateCount] = nowTime.toLocaleDateString().split("/").map(ele => Number(ele));

        init();
        function init(){
            setCalendar(nowTime);
        };

        const monthArr = ["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"];
        oMonth.addEventListener("click" , () => {
            oMonth.style.display = "none";
            [...oChangeMonth].forEach(ele => ele.style.opacity = 0);
            const oUl = document.createElement("ul");
            for(let i = 0;i < 12;i ++){
                const oLi = document.createElement("li");
                oLi.innerHTML = monthArr[i];
                oLi.className = i === nowMonthCount - 1 ? "month-item now" : "month-item";
                oUl.appendChild(oLi);
            };
            oMain.appendChild(oUl);
            const oMonthItem = document.getElementsByClassName("month-item");
            [...oMonthItem].forEach((ele ,index) => {
                ele.addEventListener("click" , () => {
                    nowMonthCount = index + 1;
                    const t = new Date(`${nowYearCount}/${nowMonthCount}/${nowDateCount}`);
                    setCalendar(t);
                    oUl.remove();
                    oMonth.style.display = "inline-block";
                    [...oChangeMonth].forEach(ele => ele.style.opacity = 1);
                } , false);
            });
        } , false);

        oYear.addEventListener("click" , () => {
            oMonth.style.display = "none";
            [...oChangeMonth].forEach(ele => ele.style.opacity = 0);
            oYear.innerHTML = `${nowYearCount - 7}年-${nowYearCount + 7}年`;
            const oUl = document.createElement("ul");
            let count = nowYearCount - 7;
            for(let i = 0;i < 15;i ++){
                const oLi = document.createElement("li");
                oLi.innerHTML = `${count}年`;
                oLi.className = i === 7 ? "year-item now" : "year-item";
                oUl.appendChild(oLi);
                count ++;
            };
            oMain.appendChild(oUl);
        } , false);

        oClear.addEventListener("click" , () => {
            oResult.innerHTML = "yyyy-MM-dd";
        } , false)

        oNowTime.addEventListener("click" , () => {
            [nowYearCount , nowMonthCount , nowDateCount] = nowTime.toLocaleDateString().split("/").map(ele => Number(ele));
            oResult.innerHTML = `${nowYearCount}-${nowMonthCount}-${nowDateCount}`;
        } , false);

        oConfirm.addEventListener("click" , () => {
            oResult.innerHTML = `${nowYearCount}-${nowMonthCount}-${nowDateCount}`;
        } , false);

        oPrevYear.addEventListener("click" , yearLess() , false);

        oPrevMonth.addEventListener("click" , () => {
            nowMonthCount --;
            if(nowMonthCount === 0){
                nowMonthCount = 12;
                nowYearCount --;
            };
            const t = new Date(`${nowYearCount}/${nowMonthCount}/${nowDateCount}`);
            setCalendar(t);
        } , false);

        oNextMonth.addEventListener("click" , () => {
            nowMonthCount ++;
            if(nowMonthCount === 13){
                nowMonthCount = 1;
                nowYearCount ++;
            };
            const t = new Date(`${nowYearCount}/${nowMonthCount}/${nowDateCount}`);
            setCalendar(t);
        } , false);

        oNextYear.addEventListener("click" , yearAdd() , false);

        [...oTime].forEach(ele => {
            ele.addEventListener("click" , () => {
                const className = ele.className,
                    html = ele.innerHTML;
                if(className.includes("prevMonth")){
                    nowMonthCount --;
                    if(nowMonthCount === 0){
                        nowMonthCount = 12;
                        nowYearCount --;
                    };
                }else if(className.includes("nextMonth")){
                    nowMonthCount ++;
                    if(nowMonthCount === 13){
                        nowMonthCount = 1;
                        nowYearCount ++;
                    };
                };
                nowDateCount = Number(html);
                const t = new Date(`${nowYearCount}/${nowMonthCount}/${nowDateCount}`);
                setCalendar(t);
            } , false);
        });

        function setCalendar(time){
            const dateArr = [31,28,31,30,31,30,31,31,30,31,30,31],
                [nowYear , nowMonth , nowDate] = time.toLocaleDateString().split("/").map(ele => Number(ele)),
                newTime = new Date(`${nowYear}/${nowMonth}/1`),  // 获取本月1号的时间
                newTimeDay = newTime.getDay(),    // 获取本月1号为周几
                prevAllDays = dateArr[nowMonth - 2 !== -1 ? nowMonth - 2 : 11],
                isLeapYear = nowYear % 4 === 0 && nowYear % 100 !== 0 || nowYear % 400 === 0,   // 判断是否为闰年
                allDays = (isLeapYear && nowMonth === 2) ? 29 : dateArr[nowMonth - 1];
            oYear.innerHTML = `${nowYear}年`;
            oMonth.innerHTML = `${nowMonth}月`;
            let rowCount = 0,
                columnCount = -1,
                count = prevAllDays - newTimeDay,
                className = "time";
            for(let i=0;i < 42;i ++){
                count ++;
                columnCount ++;
                if((count === prevAllDays + 1 && rowCount === 0) || (count === allDays + 1 && rowCount !== 0)){
                    count = 1;
                };
                const sum = rowCount * 7 + columnCount;
                if(sum < newTimeDay){
                    className = "time prevMonth";
                }else if(sum >= allDays + newTimeDay){
                    className = "time nextMonth";
                }else if(sum === newTimeDay + nowDate - 1){
                    className = "time nowTime"; 
                }else{
                    className = "time"; 
                };
                if(columnCount === 7){
                    rowCount ++;
                    columnCount = 0;
                };
                oTime[rowCount * 7 + columnCount].innerHTML = count;
                oTime[rowCount * 7 + columnCount].className = className;
            };
            oResult.innerHTML = `${nowYear}-${nowMonth}-${nowDate}`;
        };

        function yearLess(count = 1){
            return () => {
                nowYearCount -= count;
                const t = new Date(`${nowYearCount}/${nowMonthCount}/${nowDateCount}`);
                setCalendar(t);
            };
        };

        function yearAdd(count = 1){
            return () => {
                nowYearCount += count;
                const t = new Date(`${nowYearCount}/${nowMonthCount}/${nowDateCount}`);
                setCalendar(t);
            };
        };
    </script>
</body>
</html>